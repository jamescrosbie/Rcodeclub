---
title: 'R Code Club: Defensive Programming'
author: "James"
date: "12/08/2020"
output: html_document
---


```{r}
knitr::opts_chunk$set(cache=T, warning=F, error=T, message=F, echo=T, fig.width=8, fig.height=5)
```

Two types of tests:  
1. Unit Tests - used in development to check that you haven't made any mistakes  
2. Run time tests - used at run time to check that the user hasn't made a mistake while running your code

Goal is to halt proceedings if something wrong occurs rather than go through potentially expensive processing.  So we need to be able to catch issues


## Basic function 1
```{r}
taking_log <- function(x) {
    return (log(x))
}
```

### Running some tests 1
```{r}
taking_log(100)
```

```{r}
taking_log("x")
```

Back to the drawing board.... Need to include some checks

## Basic function 2
```{r}
taking_log_part2 <- function(x) {
    if (is.numeric(x)) return (log(x))
    return("Cant take log")
}
```

### Running some tests 2
```{r}
taking_log_part2(100)
```
```{r}
taking_log_part2("x")
```

These work fine. Great!

### More tests ....
```{r}
taking_log_part2(-15)
```

NaN's are numeric.  So -15 would pass our tests.  Need to build in more tests

```{r}
taking_log_part3 <- function(x) {
    if (is.numeric(x) & x > 0 ) return (log(x))
    return("Cant take log")
}
```

My tests now look like ..
```{r}
taking_log_part3(100)
taking_log_part3("x")
taking_log_part3(-15)
```

What about complex numbers ?

```{r}
taking_log_part3(6+5i)
```

or vectors 

```{r}
x <- taking_log_part3(c(1,-2))
x
```
**Note** Only the first element is checked -> we'd need to loop through each element or use purrr.  This could get complicated, if only there were a simplier way ......


## Assertive

Assert lets us check if a condition holds before proceeding

```{r}
library(assertive)
library(magrittr)
```


```{r}
assert_is_numeric(15)
```

But we can also use assertive statements with the pipe.  This makes for a very powerful method of checking

```{r}
x <- 15 %>% 
    assert_is_numeric()
x
```

```{r}
x <- 15 %>% 
    assert_is_numeric() %>% 
    assert_all_are_greater_than(0)
x
```

and they work with vectors

```{r}
x <- c(15,3) %>% 
    assert_is_numeric() %>% 
    assert_all_are_greater_than(0)
x
```

```{r}
x <- c(6+5i) %>% 
    assert_is_numeric() %>% 
    assert_all_are_greater_than(0)
x
```



## Assertive with Try/Catch  
We dont want to crash our code intentionally, and give the user some obsecure error message.  We want to be able to handle errors elegantly.


```{r}
taking_log_part5 <- function(x) {
    tryCatch(
        x %>% 
            assert_is_numeric() %>% 
            assert_all_are_positive() %>% 
            assert_all_are_greater_than(0) %>% 
            assert_is_double() %>% 
            log(),
        error=function(e){
            print(e)
            NA
        }
    )
}
```

Now, either x takes the value we want or it takes NA and we can handle that elsewhere
```{r}
x <- taking_log_part5(100)
x
```

```{r}
x <- taking_log_part5("x")
x
```


```{r}
x <- taking_log_part5(-15)
x
```


```{r}
x <- taking_log_part5(6+5i)
x
```



```{r}
x <- taking_log_part5(c(100, 1000))
x
```

Not, **every** element of our data has to pass to pass the assert statement, otherwise we could be proceding with erroneous data.  As the saying goes (GIGO) garbage in garbage out 

```{r}
x <- taking_log_part5(c(100, -15))
x
```


```{r}
x <- taking_log_part5(c(100, "x"))
x
```

## Dataframes

```{r}
x <- data.frame("A"=c(1,2,3,4,5,5), "B"=c("a", "b", "c", "d", "e", "e"))

a <- x %>% 
    has_duplicates()
a
```
There are lots of other things we could check on a dataframe besides duplicate, eg. length, class of columns, etc.  There are also lots of other assertive statements we can make  
1. assertive.datetimes  
2. assertive.string  
3. assertive.files  
for more informatin check out the documentation  [Assertive documentation](https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&cad=rja&uact=8&ved=2ahUKEwiakaSVsJDrAhUOQxUIHQOzDwIQFjACegQIAxAB&url=https%3A%2F%2Fwww.rdocumentation.org%2Fpackages%2Fassertive%2Fversions%2F0.3-6&usg=AOvVaw0zjrQLzY6TucaB4_KXMqNB)

